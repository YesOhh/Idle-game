# 打BOSS - 游戏算法文档

## 目录
1. [基础概念](#1-基础概念)
2. [攻击力算法](#2-攻击力算法)
3. [攻击速度算法](#3-攻击速度算法)
4. [里程碑算法](#4-里程碑算法)
5. [升级成本算法](#5-升级成本算法)
6. [Boss相关算法](#6-boss相关算法)
7. [圣物/遗物加成算法](#7-圣物遗物加成算法)
8. [技能算法](#8-技能算法)
9. [离线收益算法](#9-离线收益算法)

---

## 1. 基础概念

### 显示等级
```
显示等级 = 攻击力等级(damageLevel) + 攻速等级(intervalLevel) + 1
```
- 初始为1级（两个子等级均为0）
- 升级攻击力或攻速都会导致显示等级+1
- 里程碑奖励基于显示等级触发

### 佣兵属性
| 属性 | 说明 |
|------|------|
| `damage` | 基础攻击力（初始值） |
| `attackInterval` | 基础攻击间隔（秒） |
| `baseCost` | 雇佣费用，也是升级成本的基准 |
| `damageLevel` | 攻击力升级次数 |
| `intervalLevel` | 攻速升级次数 |

---

## 2. 攻击力算法

### 2.1 升级增加值查表

攻击力采用**加法增长**，每次升级增加一个查表值。

**增加值基准表**（基于 baseAtk=4）：
```
阶段:  0   1   2   3   4   5   6   7   8   9  10  11  12
增量:  2   3   4   6   9  13  19  28  42  63  95 142 212
```
超出阶段12后，按 `floor(212 × 1.5^(阶段-12))` 增长。

**阶段划分**：
```
升级 1~4 次 → 阶段 0
升级 5~9 次 → 阶段 1
升级 10~14 次 → 阶段 2
...
升级 N 次 → 阶段 = floor((N-5)/5) + 1  （N≥5时）
```

### 2.2 缩放系数

每个佣兵的增加值按自身基础攻击力缩放：
```
缩放系数 = baseAtk / 4
每次升级增加值 = max(1, floor(基准增量 × 缩放系数))
```

**举例**：士兵 baseAtk=100，缩放系数=25
- 第1次升级（阶段0）：增加 floor(2×25) = 50
- 第5次升级（阶段1）：增加 floor(3×25) = 75

### 2.3 纯升级伤害公式（不含任何加成）

```
rawDamage = baseAtk
for i = 1 to damageLevel:
    tier = getUpgradeTier(i)
    baseAdd = ADD_VALUE_TABLE[tier]  // 超出范围则 floor(212 × 1.5^(tier-12))
    addValue = max(1, floor(baseAdd × baseAtk / 4))
    rawDamage += addValue
```

**特殊**：传说系佣兵的 effectiveLevel = damageLevel + intervalLevel（升攻速也算作升攻击力）

### 2.4 最终伤害公式

```
最终攻击力 = floor(
    (rawDamage + 里程碑奖励 + 经验加成 + 重装加成)
    × (1 + 熟练Buff%)
    + 传授加成
) × 圣物伤害倍率
```

各加成项说明：
| 加成 | 存储字段 | 来源 |
|------|----------|------|
| 里程碑奖励 | `_milestoneDamageBonus` | 跨越50/100级时一次性翻倍 |
| 熟练Buff | `_stackingBuff` | 战士技能"熟练"累积 |
| 重装加成 | `_knightHeavyBonus` | 骑士技能，升级时累加 |
| 经验加成 | `_experienceBonus` | 士兵技能，每10秒累加 |
| 传授加成 | `_teachingBonus` | 士兵技能，每60秒对其他单位累加 |
| 圣物伤害倍率 | `prestigeDamageMult` | 圣物加成，乘法 |

---

## 3. 攻击速度算法

### 3.1 基础攻速公式

```
攻击间隔 = 基础间隔 × 0.99^攻速等级
```
每升1级攻速，间隔减少1%（乘法衰减）。

**特殊**：传说系佣兵的 effectiveLevel = intervalLevel + damageLevel

### 3.2 里程碑攻速奖励

```
if 显示等级 ≥ 75: 攻击间隔 *= 0.8  （提速20%）
if 显示等级 ≥ 100: 攻击间隔 *= 0.8  （再提速20%）
```
攻速里程碑是永久乘数，等价于一次性变为新值。

### 3.3 最终攻速公式

```
最终间隔 = max(0.1, 基础间隔
    × 0.99^攻速等级
    × (0.8 if 等级≥75)
    × (0.8 if 等级≥100)
    × (1 - 圣物攻速加成%)
    + 混沌惩罚秒数
)
```
最低攻击间隔为 0.1 秒。

---

## 4. 里程碑算法

里程碑是**一次性奖励**，在跨越指定等级时触发一次。

### 4.1 攻击力里程碑

| 等级 | 奖励 | 效果说明 |
|------|------|----------|
| 50级 | 攻击力翻倍 | 当前总攻击力 × 2 |
| 100级 | 攻击力再翻倍 | 当前总攻击力 × 2 |

**触发逻辑**（以50级为例）：
```
升级后显示等级达到50时：
  rawDmg = 当前纯升级伤害（不含里程碑和其他加成）
  existing = 已有的里程碑奖励（可能有之前50级的）
  _milestoneDamageBonus = rawDmg + 2 × existing
```

**100级时同理**，在已有奖励基础上再翻倍。

**数值示例**：
- 49级升到50级：rawDmg=110，existing=0 → bonus=110 → 总攻=110+110=**220**（×2）
- 50→99级正常升级：rawDmg增长到190，bonus不变=110 → 总攻=190+110=**300**
- 99级升到100级：rawDmg=190，existing=110 → bonus=190+220=410 → 总攻=190+410=**600**（×2）

### 4.2 攻速里程碑

| 等级 | 奖励 | 效果说明 |
|------|------|----------|
| 75级 | 攻速+20% | 攻击间隔 × 0.8 |
| 100级 | 攻速再+20% | 攻击间隔 × 0.8 |

攻速里程碑直接以乘数形式作用于攻击间隔公式中，因此是永久性的一次性效果。

---

## 5. 升级成本算法

### 5.1 升级费用

```
升级成本 = floor(baseUpgradeCost × 1.15^总升级次数 × 圣物折扣)
```
其中：
```
baseUpgradeCost = baseCost / 2  （如果baseCost > 0）
               = 15             （如果baseCost = 0，即玩家单位）
总升级次数 = damageLevel + intervalLevel
```
每次升级（无论攻击力还是攻速），成本增加约15%。

### 5.2 雇佣费用

```
雇佣费用 = baseCost（固定值）
```

### 5.3 佣兵雇佣费用列表

| 佣兵 | 系别 | 雇佣费用 | 基础攻击力 | 基础攻速 |
|------|------|----------|-----------|---------|
| 玩家 | 基础 | 0 | 1 | 4.0s |
| 泼猴 | 基础 | 18 | 3 | 3.2s |
| 战士 | 基础 | 40 | 5 | 4.3s |
| 弓箭手 | 基础 | 100 | 10 | 3.5s |
| 士兵 | 基础 | 1,200 | 100 | 3.6s |
| 法师 | 魔法 | 9,600 | 160 | 3.4s |
| 钢铁士兵 | 钢铁 | 57,000 | 1,900 | 3.5s |
| 夜剑客 | 魔法 | 184,000 | 2,300 | 3.2s |
| 骑士 | 钢铁 | 1,160,000 | 29,000 | 3.5s |
| 冰女 | 魔法 | 3,300,000 | 33,000 | 3.0s |
| 狂战士 | 钢铁 | 14,500,000 | 290,000 | 2.7s |
| 亡灵法师 | 魔法 | 72,000,000 | 480,000 | 3.1s |
| 圣职者 | 圣洁 | 1,500,000,000 | 5,000,000 | 4.0s |
| 龙骑士 | 圣洁 | 37,000,000,000 | 74,000,000 | 4.1s |
| 天使 | 圣洁 | 93,800,000,000 | 134,000,000 | 3.5s |
| 时光 | 远古 | 123,000,000,000 | 123,000,000 | 4.0s |
| 虚空 | 远古 | 2,160,000,000,000 | 1,800,000,000 | 3.5s |
| 凤凰 | 远古 | 2,850,000,000,000 | 1,900,000,000 | 5.0s |
| 传说 | 传说 | 10,000,000,000,000 | 5,000,000,000 | 4.5s |
| 混沌 | 传说 | 33,000,000,000,000 | 15,000,000,000 | 5.5s |
| 无极 | 传说 | 125,000,000,000,000 | 50,000,000,000 | 6.0s |

---

## 6. Boss相关算法

### 6.1 Boss血量

```
Boss血量 = floor(30000 × 135^(等级-1))
```

| Boss等级 | 名称 | 血量 |
|---------|------|------|
| 1 | 史莱姆 | 30,000 |
| 2 | 野猪王 | 4,050,000 |
| 3 | 骷髅队长 | 546,750,000 |
| 4 | 巨石傀儡 | ~7.38×10¹⁰ |
| ... | ... | 按 ×135 递增 |
| 12 | 混沌主宰 | ~30000 × 135¹¹ |

### 6.2 每次攻击伤害（含技能）

每个佣兵每隔「最终攻击间隔」攻击一次，每次攻击的伤害经过以下流程计算：

```
1. 基础伤害 = calculateUpgradedDamage(merc)
2. thisHitDamage = 基础伤害
3. 应用本单位技能：
   ├─ 爆裂/暗影突袭：     thisHitDamage × 暴击倍率（概率触发）
   ├─ 龙魂觉醒（龙息）：  thisHitDamage × burstMultiplier（每10次攻击触发）
   ├─ 狂暴：              thisHitDamage × (1 + maxBonus × bonusPercent)
   ├─ 连击：              thisHitDamage += Σ(每次连击全额伤害，概率连续触发)
   ├─ 混沌法则：          thisHitDamage × (1 + 累积混沌攻击加成)
   ├─ 钢铁神拳：          thisHitDamage += 钢铁系总攻击力 × 倍率
   ├─ 亡灵召唤：          thisHitDamage += 攻击力 × damageRatio × count
   ├─ 圣洁之力：          thisHitDamage += Boss当前血量 × 0.01%
   ├─ 虚空侵蚀：          thisHitDamage += 全队攻击力总和
   ├─ 时空涟漪：          thisHitDamage = 基础×damageMultiplier × attackCount
   ├─ 浴火重生：          thisHitDamage × multiplier（每60秒触发）
   ├─ 万物终结（暴击）：  thisHitDamage × critMult
   └─ 稳固：              thisHitDamage += 骑士全额攻击力（每8秒触发）
4. 圣物暴击：             thisHitDamage × (2.0 + critMult)（概率触发，与技能暴击互斥）
5. 全局光环加成：
   ├─ 神圣祝福光环：      thisHitDamage × (1 + aura%)
   ├─ 万物终结光环：      thisHitDamage × (1 + teamDamageBonus%)
   └─ 冰霜冻结减抗：      thisHitDamage × (1 + debuff%)
6. 最终伤害 = floor(thisHitDamage)
```

单位总伤害（`_totalDamageDealt`）= 所有攻击的最终伤害累加。

> 该值包含所有技能造成的额外伤害（暴击、连击、召唤等），反映单位实际输出。

### 6.3 额外周期伤害

以下伤害由定时器独立造成，**不计入**任何单位的 `_totalDamageDealt`：

| 来源 | 触发方式 | 伤害 |
|------|----------|------|
| 龙魂觉醒（灼烧） | 龙息触发后每秒 | floor(攻击力 × burnDamage%) × burnTicks秒 |
| 稳固 | 与攻击合并计算 | 骑士全额攻击力（已计入单位总伤害） |

> 龙骑士灼烧通过 `dealGlobalDamage` 独立造成伤害，不归属于任何单位的统计。

### 6.4 金币获取

金币按每次攻击的实际伤害计算：
```
每次攻击获得金币 = floor(实际造成伤害 × 圣物金币倍率)
```

特殊：泼猴「妙手」技能额外获得金币（独立于伤害）：
```
妙手金币 = floor(攻击力 × 妙手倍率)，直接加到玩家金币
```

---

## 7. 圣物/遗物加成算法

重生（Prestige）后获得圣物，提供永久加成。

### 7.1 圣物类型

| 类型 | 效果 | 叠加方式 |
|------|------|----------|
| damage | 伤害 +X% | 加法叠加 |
| gold | 金币 +X% | 加法叠加 |
| cost | 升级成本 -X% | 乘法叠加（每层独立） |
| speed | 攻速 +X% | 加法叠加 |
| crit_chance | 暴击率 +X% | 加法叠加 |
| crit_mult | 暴击伤害 +X% | 加法叠加 |

### 7.2 圣物池

| 圣物 | 类型 | 效果 |
|------|------|------|
| 士兵的磨刀石 | damage | 伤害 +10% |
| 勇士之证 | damage | 伤害 +30% |
| 褪色的铜币 | gold | 金币 +10% |
| 商人的契约 | gold | 金币 +30% |
| 机械发条 | speed | 攻速 +5% |
| 战术速记本 | cost | 升级成本 -5% |
| 鹰眼瞄具 | crit_chance | 暴击率 +2% |
| 锋利刀刃 | crit_mult | 暴击伤害 +20% |

### 7.3 成本折扣计算

成本折扣采用乘法叠加，防止折扣叠加到0以下：
```
costReduction = (1 - val₁)^level₁ × (1 - val₂)^level₂ × ...
```

---

## 8. 技能算法

### 8.1 技能列表与公式

#### 长大（玩家）
- 解锁：雇佣即解锁
- 效果：升级攻击力时，点击伤害同步提升为当前攻击力

#### 妙手（泼猴）
- 解锁：Lv.5
- 效果：每次攻击额外获得攻击力×倍率的金币
- 公式：`倍率 = 1.0 + floor(等级/10) × 0.1`

#### 熟练（战士）
- 解锁：Lv.10
- 效果：每次攻击概率永久+1%攻击力（叠加到 `_stackingBuff`）
- 公式：`概率 = 3% + max(0, floor((等级-10)/10) × 1%)`

#### 爆裂（弓箭手）
- 解锁：Lv.10
- 效果：20%概率暴击
- 公式：`暴击倍率 = 3.0 + max(0, floor((等级-20)/10) × 0.5)`

#### 经验（士兵·技能1）
- 解锁：雇佣即解锁
- 效果：每10秒，攻击力永久增加
- 公式：`增加值 = 1 + floor(显示等级 × 攻击力等级 / 30)`
- 存储在 `_experienceBonus` 中，加法叠加到攻击力

#### 传授（士兵·技能2）
- 解锁：Lv.15
- 效果：每60秒，使**所有**其他单位永久增加本单位**基础攻击力**（不含转生）的1%
- 公式：`加成值 = floor(士兵基础攻击力 × 0.01)`
- 士兵基础攻击力 = 升级伤害 + 里程碑 + 稳固 + 重装 + 经验（不乘转生倍率）
- 存储在每个单位的 `_teachingBonus` 中，转生倍率在最终伤害时统一生效

#### 钢铁神拳（钢铁士兵）
- 解锁：Lv.20
- 效果：10%概率造成钢铁系总攻击力×倍率的额外伤害
- 公式：`倍率 = max(0.4, 0.4 + floor((等级-20)/10) × 0.15)`

#### 重装（骑士·技能1）
- 解锁：雇佣即解锁
- 效果：升级攻击力时额外增加攻击力
- 公式：`每次升级额外 += 攻击力等级² × 显示等级`
- 存储在 `_knightHeavyBonus` 中

#### 稳固（骑士·技能2）
- 解锁：雇佣即解锁
- 效果：每隔8秒，造成等同攻击力的额外伤害
- 间隔：8秒（固定）

#### 狂暴（狂战士·技能1）
- 解锁：Lv.35
- 效果：Boss血量越低，伤害加成越高
- 公式：`最大加成 = max(1.0, 1.0 + floor((等级-35)/10) × 0.3)`
- 阶段：Boss血量 <85%/60%/35%/10% 时分别获得 25%/50%/75%/100% 的最大加成

#### 连击（狂战士·技能2）
- 解锁：Lv.50
- 效果：Boss血量越低，连击概率越高
- 概率：<85%→15%, <60%→30%, <35%→45%, <10%→60%
- 每次连击造成全额伤害（含狂暴加成），可连续触发

#### 奥术激涌（法师）
- 解锁：Lv.20
- 效果：10%概率全体攻速提升
- 公式：`攻速提升 = max(5%, 5% + floor((等级-20)/10) × 5%)`
- 持续时间：5秒

#### 暗影突袭（夜剑客）
- 解锁：Lv.20
- 效果：高概率暴击
- 公式：
  - `暴击率 = min(60%, max(35%, 35% + floor((等级-20)/10) × 5%))`
  - `暴击倍率 = max(2.0, 2.0 + floor((等级-20)/15) × 0.3)`

#### 冰霜冻结（冰女）
- 解锁：Lv.25
- 效果：12%概率使Boss受到更多伤害
- 公式：`增伤 = max(15%, 15% + floor((等级-25)/10) × 5%)`
- 持续时间：4秒

#### 亡灵召唤（亡灵法师）
- 解锁：Lv.30
- 效果：召唤骷髅协助攻击
- 公式：
  - `数量 = min(5, max(1, 1 + floor((等级-30)/20)))`
  - `单体伤害 = max(10%, 10% + floor((等级-30)/10) × 3%) × 攻击力`

#### 神圣祝福（圣职者）
- 解锁：Lv.25
- 效果：全队永久伤害加成光环
- 公式：`加成 = max(8%, 8% + floor((等级-25)/10) × 3%)`

#### 龙魂觉醒（龙骑士）
- 解锁：Lv.40
- 效果：每10次攻击释放龙息+灼烧
- 公式：
  - `龙息倍率 = max(50, 50 + floor((等级-40)/10) × 15)`
  - `灼烧伤害 = max(5%, 5% + floor((等级-40)/15) × 2%) / 秒`

#### 圣洁之力（天使）
- 解锁：Lv.30
- 效果：概率造成Boss当前血量0.01%真实伤害（不受任何加成影响）
- 公式：`概率 = max(8%, 8% + floor((等级-30)/20) × 2%)`

#### 时空涟漪（时光）
- 解锁：Lv.35
- 效果：每60秒释放多次时空攻击
- 公式：
  - `次数 = min(12, 6 + floor((等级-35)/20))`
  - `伤害倍率 = max(1.0, 1.0 + floor((等级-35)/10) × 0.2)`

#### 虚空侵蚀（虚空）
- 解锁：Lv.40
- 效果：概率造成全队攻击力总和的伤害
- 公式：`概率 = max(10%, 10% + floor((等级-40)/15) × 3%)`

#### 浴火重生（凤凰）
- 解锁：Lv.35
- 效果：每60秒自动造成超高倍伤害
- 公式：`倍率 = max(50, 50 + floor((等级-35)/10) × 20)`

#### 全能（传说）
- 解锁：雇佣即解锁
- 效果：升级攻击力时攻速也提升，反之亦然
- 实现：damageLevel 和 intervalLevel 在计算时互相叠加

#### 混沌法则（混沌）
- 解锁：Lv.45
- 效果：概率增加攻击力，但也增加攻击间隔
- 公式：
  - `概率 = max(15%, 15% + floor((等级-45)/10) × 3%)`
  - `攻击力加成 = max(5%, 5% + floor((等级-45)/15) × 2%)`
  - `攻击间隔惩罚 = +0.1秒（每次触发固定）`

#### 万物终结（无极）
- 解锁：Lv.50
- 效果：全队增伤+增速+暴击
- 公式：
  - `全队增伤 = max(15%, 15% + floor((等级-50)/10) × 5%)`
  - `全队增速 = 增伤 × 50%`
  - `暴击 = 25%概率 5.0倍`

---

## 9. 离线收益算法

### 9.1 离线时间

```
最大离线时间 = 8小时 (28800秒)
实际计算时间 = min(离线时长, 28800)
```

### 9.2 离线伤害

```
每个佣兵的离线伤害 = floor(离线时间 / 攻击间隔) × 攻击力
总离线伤害 = Σ 各佣兵离线伤害
```
> 注：离线计算不触发技能效果，仅计算纯攻击伤害。

### 9.3 离线击杀Boss

用总离线伤害模拟逐Boss击杀：
```
while 剩余伤害 > 0 且 Boss等级 ≤ 12:
    if 剩余伤害 ≥ 当前Boss血量:
        剩余伤害 -= Boss血量
        Boss等级++ (最高12级)
    else:
        break
```

### 9.4 离线金币

```
离线金币 = floor(总离线伤害 × 圣物金币倍率)
```
