<!-- pages/battle/battle.wxml -->
<view class="battle-container {{isSpeedBuffActive ? 'buff-speed' : ''}} {{isDamageBuffActive ? 'buff-damage' : ''}}">
  <!-- ========== å›ºå®šçš„BossåŒºåŸŸ ========== -->
  <view class="boss-section">
    <view class="boss-level">
      Boss Lv.{{boss.level}}
      <text wx:if="{{prestigeCount > 0}}" class="prestige-badge">ğŸ–ï¸ ç¬¬{{prestigeCount + 1}}å‘¨ç›®</text>
    </view>
    
    <!-- Bossç²¾çµ -->
    <view class="boss-sprite" bindtap="onTapBoss">
      <view class="boss-icon {{attacking ? 'shake' : ''}}">ğŸ‘¹</view>
      
      <!-- ä¼¤å®³æ•°å­—åŠ¨ç”» -->
      <view wx:for="{{damageNumbers}}" wx:key="id" class="damage-number {{item.type}}" 
            style="left: {{item.x}}rpx; top: {{item.y}}rpx;">
        {{item.damage}}
      </view>
    </view>
    
    <!-- Bossè¡€æ¡ -->
    <view class="boss-hp-container">
      <view class="boss-hp-label">
        <text>{{bossHpText}}</text>
      </view>
      <view class="pixel-progress">
        <view class="pixel-progress-fill" style="width: {{bossHpPercent}}%"></view>
      </view>
    </view>
  </view>
  
  <!-- ========== é‡‘å¸ç»Ÿè®¡æ  ========== -->
  <view class="stats-compact">
    <view class="stat-compact">
      <text class="stat-compact-label">ğŸ’°</text>
      <text class="stat-compact-value">{{goldText}}</text>
    </view>
  </view>

  <!-- ========== æˆ˜æ–—ä½£å…µå†…å®¹ ========== -->
  <view class="tab-content">
    <scroll-view scroll-y class="mercenaries-scroll">
      <view class="mercenaries-section">
        <view wx:for="{{mercenaries}}" wx:key="id" class="merc-item-card {{item.expanded ? 'expanded' : ''}}">
          <!-- å¡ç‰‡å¤´éƒ¨ - ç‚¹å‡»å±•å¼€/æŠ˜å  -->
          <view class="merc-card-header" bindtap="onToggleMercExpand" data-id="{{item.id}}">
            <view class="merc-icon-box">
              <text class="merc-icon-large">{{item.icon}}</text>
            </view>
            
            <view class="merc-info-main">
              <!-- ç¬¬ä¸€è¡Œï¼šåç§° + ç­‰çº§ -->
              <view class="merc-title-row">
                <text class="merc-name">{{item.name}}</text>
                <text class="merc-level">ç­‰çº§ï¼š{{item.totalLevel}}</text>
              </view>
              
              <!-- å·²é›‡ä½£æ˜¾ç¤ºå±æ€§ -->
              <view wx:if="{{item.recruited}}" class="merc-stats-row">
                <text class="merc-stat">æ”»å‡»åŠ›ã€€{{item.damageText}}</text>
              </view>
              <view wx:if="{{item.recruited}}" class="merc-stats-row">
                <text class="merc-stat">æ”»å‡»é—´éš”ã€€{{item.intervalText}}ç§’</text>
              </view>
              
              <!-- æœªé›‡ä½£æ˜¾ç¤ºé¢„è§ˆ -->
              <view wx:if="{{!item.recruited}}" class="merc-stats-row">
                <text class="merc-stat">åˆå§‹æ”»å‡»ã€€{{item.baseDamage}}</text>
              </view>
              <view wx:if="{{!item.recruited}}" class="merc-stats-row">
                <text class="merc-stat">æ”»å‡»é—´éš”ã€€{{item.baseInterval}}ç§’</text>
              </view>
              
              <!-- æŠ€èƒ½æ ‡ç­¾ -->
              <view wx:if="{{item.skillInfo}}" class="merc-skill-tag">
                <text class="skill-tag {{item.skillInfo.isUnlocked ? 'unlocked' : 'locked'}}">[{{item.skillInfo.shortName}}]</text>
              </view>
            </view>
            
            <!-- æœªé›‡ä½£æ˜¾ç¤ºæ‹›å‹ŸæŒ‰é’® -->
            <button 
              wx:if="{{!item.recruited}}"
              class="merc-recruit-btn {{item.canAfford ? '' : 'disabled'}}" 
              catchtap="onRecruitMercenary" 
              data-id="{{item.id}}"
              disabled="{{!item.canAfford}}">
              ğŸ’°{{item.costText}}
            </button>
          </view>
          
          <!-- å±•å¼€å†…å®¹ - ä»…å·²é›‡ä½£ä¸”å±•å¼€æ—¶æ˜¾ç¤º -->
          <view wx:if="{{item.recruited && item.expanded}}" class="merc-expand-content">
            <!-- å‡çº§æ”»å‡»åŠ› -->
            <view class="upgrade-box" catchtap="onUpgradeDamage" data-id="{{item.id}}">
              <view class="upgrade-info">
                <text class="upgrade-title">å‡çº§æ”»å‡»åŠ› ç­‰çº§ {{item.damageLevel + 1}}</text>
                <text class="upgrade-effect">æ”»å‡»åŠ› +{{item.damageUpgradeEffect}}</text>
              </view>
              <view class="upgrade-cost {{item.canAffordUpgrade ? '' : 'disabled'}}">
                <text>èŠ±è´¹ã€€ğŸ’° {{item.upgradeCostText}}</text>
              </view>
            </view>
            
            <!-- å‡çº§æ”»å‡»é€Ÿåº¦ -->
            <view class="upgrade-box" catchtap="onUpgradeInterval" data-id="{{item.id}}">
              <view class="upgrade-info">
                <text class="upgrade-title">å‡çº§æ”»å‡»é€Ÿåº¦ ç­‰çº§ {{item.intervalLevel + 1}}</text>
                <text class="upgrade-effect">æ”»å‡»é—´éš” -{{item.intervalUpgradeEffect}}ç§’</text>
              </view>
              <view class="upgrade-cost {{item.canAffordUpgrade ? '' : 'disabled'}}">
                <text>èŠ±è´¹ã€€ğŸ’° {{item.upgradeCostText}}</text>
              </view>
            </view>
            
            <!-- ä½£å…µæè¿° -->
            <view class="merc-description">
              <text>{{item.description}}</text>
            </view>
            
            <!-- æŠ€èƒ½è¯¦æƒ… - å§‹ç»ˆæ˜¾ç¤ºæ•ˆæœ -->
            <view wx:if="{{item.skillInfo}}" class="skill-detail">
              <view class="skill-detail-header">
                <text class="skill-detail-name {{item.skillInfo.isUnlocked ? 'unlocked' : 'locked'}}">{{item.skillInfo.shortName}}</text>
                <text wx:if="{{!item.skillInfo.isUnlocked}}" class="skill-unlock-condition">{{item.skillInfo.unlockCondition}}</text>
              </view>
              <view class="skill-detail-desc">{{item.skillInfo.desc}}</view>
            </view>
          </view>
        </view>
      </view>
    </scroll-view>
    
    <!-- é‡ç½®æ¸¸æˆæŒ‰é’® -->
    <view class="reset-section">
      <button class="stats-btn" bindtap="onShowStats">ğŸ“Š æˆ˜å†µç»Ÿè®¡</button>
      <button class="reset-btn" bindtap="onResetGame">ğŸ”„ é‡æ–°å¼€å§‹æ¸¸æˆ</button>
    </view>

    <!-- å…‘æ¢ç åŒºåŸŸ -->
    <view class="redeem-section">
      <view class="redeem-title">å…‘æ¢ç </view>
      <view class="redeem-input-group">
        <input class="redeem-input" placeholder="è¾“å…¥å…‘æ¢ç " bindinput="onInputCode" value="{{redemptionCode}}" />
        <button class="redeem-btn" bindtap="onRedeem">å…‘æ¢</button>
      </view>
    </view>

    <!-- è‡ªåŠ¨åŒ–æµ‹è¯•åŒºåŸŸ (å¼€å‘è°ƒè¯•) -->
    <view class="test-section">
      <view class="test-title">ğŸ› ï¸ è‡ªåŠ¨åŒ–æµ‹è¯• (å¼€å‘è°ƒè¯•)</view>
      <view class="test-row">
        <picker class="test-picker" bindchange="onMercChange" range="{{mercenaries}}" range-key="name">
          <view class="picker-val">{{autoUpgradeMercId ? autoUpgradeMercName : 'é€‰æ‹©ä½£å…µ'}}</view>
        </picker>
        <picker class="test-picker" bindchange="onTypeChange" range="{{upgradeTypes}}" range-key="label">
          <view class="picker-val">{{autoUpgradeTypeLabel}}</view>
        </picker>
        <view class="test-switch-wrapper">
          <text class="test-switch-label">å¼€å¯è‡ªåŠ¨å‡çº§</text>
          <switch checked="{{autoUpgradeEnabled}}" bindchange="onToggleAutoUpgrade" color="#2ecc71" size="20" />
        </view>
      </view>
    </view>
  </view>
</view>

<!-- ç¦»çº¿æ”¶ç›Šå¼¹çª— -->
<view wx:if="{{showOfflineModal}}" class="modal-overlay" bindtap="closeOfflineModal">
  <view class="modal-content pixel-card" catchtap="preventClose">
    <view class="modal-title">ç¦»çº¿æ”¶ç›Š</view>
    <view class="modal-body">
      <text>ç¦»çº¿æ—¶é—´: {{offlineTimeText}}</text>
      <text>è·å¾—é‡‘å¸: {{offlineGoldText}}</text>
      <text>å‡»è´¥Boss: {{offlineBossesText}}</text>
    </view>
    <button class="pixel-button" bindtap="closeOfflineModal">é¢†å–</button>
  </view>
</view>

<!-- é—ç‰©é€‰æ‹©å¼¹çª— -->
<view wx:if="{{showRelicModal}}" class="modal-overlay">
  <view class="modal-content pixel-card" style="width: 90%; max-height: 80vh;">
    <view class="modal-title">ğŸ† å‡¯æ—‹å½’æ¥ï¼è¯·é€‰æ‹©ä¸€ä»¶æˆ˜åˆ©å“</view>
    <view class="modal-body" style="padding: 20rpx 0;">
        <view class="relic-list">
            <view wx:for="{{relicChoices}}" wx:key="id" class="relic-card" bindtap="onSelectRelic" data-index="{{index}}">
                <view class="relic-icon">{{item.icon}}</view>
                <view class="relic-name">{{item.name}}</view>
                <view class="relic-desc">{{item.desc}}</view>
            </view>
        </view>
    </view>
    <view class="text-muted" style="text-align: center; font-size: 20rpx; margin-top: 20rpx;">æç¤ºï¼šé€‰æ‹©åå°†å¼€å¯ä¸‹ä¸€å‘¨ç›®</view>
  </view>
</view>

<!-- æˆ˜å†µç»Ÿè®¡å¼¹çª— -->
<view wx:if="{{showStatsModal}}" class="modal-overlay" bindtap="closeStatsModal">
  <view class="modal-content pixel-card" catchtap="preventClose">
    <view class="modal-title">ğŸ“‰ æˆ˜å†µç»Ÿè®¡</view>
    <scroll-view scroll-y class="stats-scroll" style="max-height: 400rpx; margin-bottom: 20rpx;">
      <view class="stats-table">
        <view class="stats-header">
          <text class="col-lvl">Boss</text>
          <text class="col-time">å‡»æ€æ—¶é•¿</text>
        </view>
        <view wx:for="{{displayBossStats}}" wx:key="level" class="stats-row">
          <text class="col-lvl">Lv.{{item.level}} {{item.name}}</text>
          <text class="col-time">{{item.timeStr}}</text>
        </view>
        <view wx:if="{{!displayBossStats.length}}" class="empty-stats">æš‚æ— å‡»æ€è®°å½•</view>
      </view>
    </scroll-view>
    <view class="total-stats">
      <text>æ€»é€šå…³è€—æ—¶:</text>
      <text class="total-val">{{displayTotalTime}}</text>
    </view>
    <button class="pixel-button" bindtap="closeStatsModal">å…³é—­</button>
  </view>
</view>
