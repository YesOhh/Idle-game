<!-- pages/battle/battle.wxml -->
<view class="battle-container {{isSpeedBuffActive ? 'buff-speed' : ''}} {{isDamageBuffActive ? 'buff-damage' : ''}}">
  <!-- Bossä¿¡æ¯åŒºåŸŸ -->
  <view class="boss-section">
    <view class="boss-level">
      Boss Lv.{{boss.level}}
      <text wx:if="{{prestigeCount > 0}}" style="color: #f1c40f; font-size: 22rpx; margin-left: 10rpx;">ğŸ–ï¸ ç¬¬{{prestigeCount + 1}}å‘¨ç›®</text>
    </view>
    
    <!-- Bossç²¾çµ -->
    <view class="boss-sprite" bindtap="onTapBoss">
      <view class="boss-icon {{attacking ? 'shake' : ''}}">ğŸ‘¹</view>
      
      <!-- ä¼¤å®³æ•°å­—åŠ¨ç”» -->
      <view wx:for="{{damageNumbers}}" wx:key="id" class="damage-number {{item.type}}" 
            style="left: {{item.x}}rpx; top: {{item.y}}rpx; animation-delay: {{item.delay}}ms">
        {{item.damage}}
      </view>
    </view>
    
    <!-- Bossè¡€æ¡ -->
    <view class="boss-hp-container">
      <view class="boss-hp-label">
        <text>{{bossHpText}}</text>
      </view>
      <view class="pixel-progress">
        <view class="pixel-progress-fill" style="width: {{bossHpPercent}}%"></view>
      </view>
    </view>
  </view>
  
  <!-- ç´§å‡‘çš„ç»Ÿè®¡ä¿¡æ¯ -->
  <view class="stats-compact">
    <view class="stat-compact">
      <text class="stat-compact-label">ğŸ’°</text>
      <text class="stat-compact-value">{{goldText}}</text>
    </view>
  </view>
  <!-- ä½£å…µåˆ—è¡¨ -->
  
  <!-- ä½£å…µåˆ—è¡¨ -->
  <scroll-view scroll-y class="mercenaries-scroll" style="max-height: 60vh;">
    <view class="mercenaries-section">
      
      <view wx:for="{{mercenaries}}" wx:key="id" class="merc-item">
        <view class="merc-left">
          <text class="merc-icon-small">{{item.icon}}</text>
          <view class="merc-info-compact">
            <text class="merc-name-small">{{item.name}}</text>
            <!-- <text class="merc-count">x{{item.count}}</text> ç§»é™¤æ•°é‡æ˜¾ç¤º -->
          </view>
        </view>
        
        <view class="merc-right">
          <!-- æœªé›‡ä½£æ˜¾ç¤ºDPSé¢„è§ˆ -->
          <view wx:if="{{!item.recruited}}" class="merc-dps-info">
            <text class="merc-dps-label">DPS:</text>
            <text class="merc-dps-value">{{item.dpsText}}</text>
          </view>

          <!-- å·²é›‡ä½£æ˜¾ç¤ºè¯¦ç»†å±æ€§ (Gridå¸ƒå±€ - 2è¡Œ) -->
          <view wx:else class="merc-stats-grid">
             <!-- ç¬¬ä¸€è¡Œ: æ”»å‡» + æ”»é€Ÿ -->
             <view class="stats-row-compact">
                <view class="stat-pill damage small">
                   <text class="stat-icon">âš”ï¸</text>
                   <text class="stat-val">{{item.damageText}}</text>
                   <!-- ç©ºé—´ä¸å¤Ÿæ—¶å¯ä»¥éšè—Lvï¼Œæˆ–è€…ç¼©å° -->
                   <!-- <text class="stat-lvl">Lv.{{item.damageLevel}}</text> -->
                </view>
                
                <view class="stat-pill speed small">
                   <text class="stat-icon">âš¡</text>
                   <text class="stat-val">{{item.intervalText}}s</text>
                </view>
             </view>

             <!-- ç¬¬äºŒè¡Œ: DPS -->
             <view class="stat-pill dps">
                <text class="stat-icon">ğŸ”¥</text>
                <text class="stat-val">DPS: {{item.dpsText}}</text>
             </view>
          </view>

          <!-- ä»…æœªé›‡ä½£æ—¶æ˜¾ç¤ºæ‹›å‹ŸæŒ‰é’® -->
          <button 
            wx:if="{{!item.recruited}}"
            class="merc-recruit-btn {{item.canAfford ? '' : 'disabled'}}" 
            bindtap="onRecruitMercenary" 
            data-id="{{item.id}}"
            disabled="{{!item.canAfford}}">
            {{item.costText}}
          </button>
        </view>
      </view>
    </view>
  </scroll-view>
    
    <!-- é‡ç½®æ¸¸æˆæŒ‰é’® -->
    <view class="reset-section">
      <button class="stats-btn" bindtap="onShowStats">ğŸ“Š æˆ˜å†µç»Ÿè®¡</button>
      <button class="reset-btn" bindtap="onResetGame">ğŸ”„ é‡æ–°å¼€å§‹æ¸¸æˆ</button>
    </view>

    <!-- å…‘æ¢ç åŒºåŸŸ -->
    <view class="redeem-section">
      <view class="redeem-title">å…‘æ¢ç </view>
      <view class="redeem-input-group">
        <input class="redeem-input" placeholder="è¾“å…¥å…‘æ¢ç " bindinput="onInputCode" value="{{redemptionCode}}" />
        <button class="redeem-btn" bindtap="onRedeem">å…‘æ¢</button>
      </view>
    </view>

    <!-- è‡ªåŠ¨åŒ–æµ‹è¯•åŒºåŸŸ (å¼€å‘è°ƒè¯•) -->
    <view class="test-section">
      <view class="test-title">ğŸ› ï¸ è‡ªåŠ¨åŒ–æµ‹è¯• (å¼€å‘è°ƒè¯•)</view>
      <view class="test-row">
        <picker class="test-picker" bindchange="onMercChange" range="{{mercenaries}}" range-key="name">
          <view class="picker-val">{{autoUpgradeMercId ? autoUpgradeMercName : 'é€‰æ‹©ä½£å…µ'}}</view>
        </picker>
        <picker class="test-picker" bindchange="onTypeChange" range="{{upgradeTypes}}" range-key="label">
          <view class="picker-val">{{autoUpgradeTypeLabel}}</view>
        </picker>
        <view class="test-switch-wrapper">
          <text class="test-switch-label">å¼€å¯è‡ªåŠ¨å‡çº§</text>
          <switch checked="{{autoUpgradeEnabled}}" bindchange="onToggleAutoUpgrade" color="#2ecc71" size="20" />
        </view>
      </view>
    </view>


</view>

<!-- ç¦»çº¿æ”¶ç›Šå¼¹çª— -->
<view wx:if="{{showOfflineModal}}" class="modal-overlay" bindtap="closeOfflineModal">
  <view class="modal-content pixel-card" catchtap="preventClose">
    <view class="modal-title">ç¦»çº¿æ”¶ç›Š</view>
    <view class="modal-body">
      <text>ç¦»çº¿æ—¶é—´: {{offlineTimeText}}</text>
      <text>è·å¾—é‡‘å¸: {{offlineGoldText}}</text>
      <text>å‡»è´¥Boss: {{offlineBossesText}}</text>
    </view>
    <button class="pixel-button" bindtap="closeOfflineModal">é¢†å–</button>
  </view>
</view>

<!-- é—ç‰©é€‰æ‹©å¼¹çª— -->
<view wx:if="{{showRelicModal}}" class="modal-overlay">
  <view class="modal-content pixel-card" style="width: 90%; max-height: 80vh;">
    <view class="modal-title">ğŸ† å‡¯æ—‹å½’æ¥ï¼è¯·é€‰æ‹©ä¸€ä»¶æˆ˜åˆ©å“</view>
    <view class="modal-body" style="padding: 20rpx 0;">
        <view class="relic-list">
            <view wx:for="{{relicChoices}}" wx:key="id" class="relic-card" bindtap="onSelectRelic" data-index="{{index}}">
                <view class="relic-icon">{{item.icon}}</view>
                <view class="relic-name">{{item.name}}</view>
                <view class="relic-desc">{{item.desc}}</view>
            </view>
        </view>
    </view>
    <view class="text-muted" style="text-align: center; font-size: 20rpx; margin-top: 20rpx;">æç¤ºï¼šé€‰æ‹©åå°†å¼€å¯ä¸‹ä¸€å‘¨ç›®</view>
  </view>
</view>

<!-- æˆ˜å†µç»Ÿè®¡å¼¹çª— -->
<view wx:if="{{showStatsModal}}" class="modal-overlay" bindtap="closeStatsModal">
  <view class="modal-content pixel-card" catchtap="preventClose">
    <view class="modal-title">ğŸ“‰ æˆ˜å†µç»Ÿè®¡</view>
    <scroll-view scroll-y class="stats-scroll" style="max-height: 400rpx; margin-bottom: 20rpx;">
      <view class="stats-table">
        <view class="stats-header">
          <text class="col-lvl">Boss</text>
          <text class="col-time">å‡»æ€æ—¶é•¿</text>
        </view>
        <view wx:for="{{displayBossStats}}" wx:key="level" class="stats-row">
          <text class="col-lvl">Lv.{{item.level}} {{item.name}}</text>
          <text class="col-time">{{item.timeStr}}</text>
        </view>
        <view wx:if="{{!displayBossStats.length}}" class="empty-stats">æš‚æ— å‡»æ€è®°å½•</view>
      </view>
    </scroll-view>
    <view class="total-stats">
      <text>æ€»é€šå…³è€—æ—¶:</text>
      <text class="total-val">{{displayTotalTime}}</text>
    </view>
    <button class="pixel-button" bindtap="closeStatsModal">å…³é—­</button>
  </view>
</view>
